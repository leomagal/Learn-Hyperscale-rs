graph TD
    A["ğŸš€ Epoch Start<br/>Height = 0, Round = 0"] --> B["ğŸ‘‘ Leader Election<br/>Leader = Validator[Height % N]"]
    B --> C["ğŸ“ Propose Block<br/>Block(Height, Round, Txs)"]
    C --> D["ğŸ“¥ Nodes Receive"]
    D --> E["âœ… Validate Block"]
    
    E -->|Invalid| F["âŒ Reject"]
    F --> G["â±ï¸ Timeout"]
    
    E -->|Valid| H["ğŸ”’ Check Vote Lock<br/>voted_heights[Height]?"]
    
    H -->|Locked| I["ğŸš« Cannot Vote<br/>Already locked"]
    I --> G
    
    H -->|Not Locked| J["ğŸ—³ï¸ Vote on Block"]
    J --> K["ğŸ“Š Collect Votes"]
    K --> L{"2f+1 Votes?"}
    
    L -->|No| M["â±ï¸ Timeout"]
    M --> N["ğŸ”„ View Change<br/>Round += 1"]
    N --> O["ğŸ”“ Unlock Votes<br/>Remove all locks"]
    O --> B
    
    L -->|Yes| P["âœï¸ Aggregate Signatures<br/>BLS12-381"]
    P --> Q["ğŸ–ï¸ Create QC<br/>QC(Height, Round)"]
    Q --> R["ğŸ“¡ Broadcast QC"]
    
    R --> S["ğŸ“¥ Receive QC"]
    S --> T["ğŸ”„ Sync View<br/>if QC.round > local.view:<br/>  local.view = QC.round"]
    T --> U["ğŸ”“ Unlock Votes<br/>Remove locks â‰¤ QC.height"]
    
    U --> V{"Two-Chain Rule?<br/>Parent QC exists?"}
    
    V -->|No| W["â³ Wait for Next QC"]
    W --> N
    
    V -->|Yes| X["âœ… Commit Block"]
    X --> Y["âš™ï¸ Execute Transactions"]
    Y --> Z["ğŸ’¾ Update State Root"]
    
    Z --> AA{"Epoch End?<br/>Height >= Threshold"}
    
    AA -->|No| AB["â• Next Height<br/>Height += 1<br/>Round = 0"]
    AB --> B
    
    AA -->|Yes| AC["ğŸ‰ New Epoch<br/>Height += 1<br/>Round = 0"]
    AC --> A
    
    G --> AD["â±ï¸ View Change Timer<br/>Timeout X seconds"]
    AD --> N
    
    style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style X fill:#51cf66,stroke:#2f9e44,color:#fff
    style Q fill:#4dabf7,stroke:#1971c2,color:#fff
    style T fill:#ffd43b,stroke:#f59f00,color:#000
    style U fill:#ffd43b,stroke:#f59f00,color:#000
    style H fill:#a78bfa,stroke:#7c3aed,color:#fff
