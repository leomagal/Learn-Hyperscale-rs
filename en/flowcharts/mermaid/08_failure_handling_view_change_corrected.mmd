graph TD
    A["â±ï¸ Round Timeout<br/>Leader Does Not Propose"] --> B["ğŸš¨ Detect Failure<br/>Waited X seconds"]
    B --> C["ğŸ”“ Unlock Vote<br/>Remove Vote Locks"]
    C --> D["â• Increment View<br/>View += 1<br/>Round += 1"]
    D --> E["ğŸ‘‘ New Leader<br/>Leader = Validator[Round % N]"]
    E --> F{"New Leader<br/>Honest?"}
    
    F -->|No| G["â±ï¸ Timeout Again<br/>Repeat View Change"]
    G --> D
    
    F -->|Yes| H["ğŸ“ New Leader Proposes<br/>Block with HighQC"]
    H --> I["ğŸ”„ Synchronization<br/>Nodes Receive Proposal"]
    I --> J["âœ… Validate Block<br/>- Signature<br/>- Merkle Root<br/>- State Root"]
    
    J -->|Invalid| K["âŒ Reject<br/>New Timeout"]
    K --> D
    
    J -->|Valid| L["ğŸ”’ Check Vote Lock<br/>voted_heights[Height]?"]
    
    L -->|Locked| M["ğŸš« Cannot Vote<br/>Already locked"]
    M --> K
    
    L -->|Not Locked| N["ğŸ—³ï¸ Vote on Block"]
    N --> O["ğŸ“Š Collect Votes<br/>2f+1 Required"]
    O --> P{"Quorum<br/>Reached?"}
    
    P -->|No| Q["â³ Wait for More Votes"]
    Q --> K
    
    P -->|Yes| R["âœï¸ Aggregate Signatures<br/>BLS12-381 Aggregation"]
    R --> S["ğŸ–ï¸ Create QC<br/>QC(Height, Round)"]
    S --> T["ğŸ“¡ Broadcast QC<br/>Send to all nodes"]
    
    T --> U["ğŸ“¥ Nodes Receive QC"]
    U --> V["ğŸ”„ Sync View<br/>if QC.round > local.view:<br/>  local.view = QC.round"]
    V --> W["ğŸ”“ Unlock Votes<br/>Remove locks â‰¤ QC.height"]
    
    W --> X["âœ… System Recovers<br/>Consensus Restored"]
    X --> Y["ğŸ Back to Normal<br/>Continue Consensus"]
    
    style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style C fill:#ffd43b,stroke:#f59f00,color:#000
    style D fill:#ffd43b,stroke:#f59f00,color:#000
    style E fill:#51cf66,stroke:#2f9e44,color:#fff
    style H fill:#4dabf7,stroke:#1971c2,color:#fff
    style V fill:#ffd43b,stroke:#f59f00,color:#000
    style W fill:#ffd43b,stroke:#f59f00,color:#000
    style X fill:#51cf66,stroke:#2f9e44,color:#fff
