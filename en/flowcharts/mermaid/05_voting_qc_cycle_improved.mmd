graph TD
    A["ğŸ“ Block Proposed<br/>Block(Height, Round, Txs)"] --> B["ğŸ“¥ Node Receives Proposal"]
    B --> C["âœ… Validate Block<br/>- Leader Signature<br/>- Merkle Root<br/>- State Root<br/>- Parent QC"]
    
    C -->|Invalid| D["âŒ Reject<br/>Does not vote"]
    D --> E["End"]
    
    C -->|Valid| F["ğŸ”’ Verify Vote Lock<br/>Check: QC.Round > Locked.Round?"]
    
    F -->|No| G["âœ… Lock is Valid<br/>Can vote"]
    F -->|Yes| H["ğŸ”“ Lock Expired<br/>Can vote"]
    
    G --> I["ğŸ—³ï¸ Create Vote<br/>Vote(Block, Validator, Sig)"]
    H --> I
    
    I --> J["ğŸ“¢ Broadcast Vote<br/>Send to all nodes"]
    J --> K["ğŸ“Š Vote Collection<br/>VoteSet at Leader"]
    K --> L{"2f+1 Votes<br/>Received?"}
    
    L -->|No| M["â³ Wait for More Votes"]
    M --> N{"Timeout?"}
    N -->|Yes| O["â±ï¸ Skip to Next Round"]
    N -->|No| M
    
    L -->|Yes| P["âœï¸ Batch Verification<br/>Verify all votes"]
    P -->|Fail| Q["âŒ Reject Votes<br/>Invalid signatures"]
    Q --> O
    
    P -->|Success| R["ğŸ”— Aggregate Signatures<br/>BLS12-381 Aggregation"]
    R --> S["ğŸ–ï¸ Create Quorum Certificate<br/>QC(Block, Signers, AggSig)"]
    S --> T["ğŸ“¡ Broadcast QC<br/>Send to all nodes"]
    
    T --> U["ğŸ“¥ Nodes Receive QC"]
    U --> V["ğŸ”„ Sync View<br/>if QC.round > local.view:<br/>  local.view = QC.round"]
    V --> W["ğŸ”“ Unlock Votes<br/>Remove locks for h â‰¤ QC.height"]
    
    W --> X{"Two-Chain Rule?<br/>QC.parent_qc exists?"}
    
    X -->|No| Y["â³ Wait for Next QC"]
    Y --> O
    
    X -->|Yes| Z["âœ… Block Committed<br/>Two-chain rule satisfied"]
    Z --> AA["âš™ï¸ Execute Transactions<br/>Update State Root"]
    AA --> AB["ğŸ’¾ Block Finalized"]
    AB --> AC["ğŸ End"]
    
    O --> AC
    E --> AC
    
    style A fill:#ff6b6b,stroke:#c92a2a,color:#fff
    style F fill:#a78bfa,stroke:#7c3aed,color:#fff
    style I fill:#4dabf7,stroke:#1971c2,color:#fff
    style S fill:#51cf66,stroke:#2f9e44,color:#fff
    style V fill:#ffd43b,stroke:#f59f00,color:#000
    style W fill:#ffd43b,stroke:#f59f00,color:#000
    style Z fill:#51cf66,stroke:#2f9e44,color:#fff
