graph TD
    Start["ğŸš€ Normal Operation"]
    Timeout["â±ï¸ Timeout<br/>No QC formed"]
    FailureDetect["âŒ Failure Detected<br/>Round R failed"]
    CheckQCHeight{"QC at height H?<br/>latest_qc.height < H"}
    ClearVoteLock["ğŸ”“ Clear Vote Lock<br/>voted_heights[H] = None"]
    KeepVoteLock["ğŸ”’ Keep Vote Lock<br/>voted_heights[H] = B"]
    ViewIncrement["ğŸŒŸ Increment View<br/>view = R+1"]
    LeaderElection["ğŸ‘‘ New Leader Election<br/>for view R+1"]
    IsNewLeader{"Are we<br/>new leader?"}
    ReproposeLocked["ğŸ“ Re-propose Locked Block<br/>voted_heights[H] = B"]
    ProposeNew["ğŸ“ Propose New Block<br/>voted_heights[H] = None"]
    BroadcastProposal["ğŸ“Š Broadcast Proposal"]
    NodesReceive["ğŸ“ Nodes Receive Proposal"]
    ValidateProposal["âœ… Validate Proposal"]
    CheckVoteLock{"ğŸ”’ Check Vote Lock<br/>voted_heights[H]?"}
    CanVote{"Can Vote?"}
    Vote["ğŸ—³ï¸ Create Vote"]
    BroadcastVote["ğŸ“Š Broadcast Vote"]
    CollectVotes["ğŸ“Š Collect Votes"]
    QuorumCheck{"Quorum?"}
    CreateQC["ğŸ–ï¸ Create QC"]
    ViewSync["ğŸŒŸ View Sync"]
    CommitCheck{"Two-Chain Rule?"}
    Execute["âš¡ Execute Transactions"]
    Recovered["âœ… System Recovered"]
    
    Start --> Timeout
    Timeout --> FailureDetect
    FailureDetect --> CheckQCHeight
    CheckQCHeight -->|No QC| ClearVoteLock
    CheckQCHeight -->|QC formed| KeepVoteLock
    ClearVoteLock --> ViewIncrement
    KeepVoteLock --> ViewIncrement
    ViewIncrement --> LeaderElection
    LeaderElection --> IsNewLeader
    IsNewLeader -->|Yes| ReproposeLocked
    IsNewLeader -->|No| BroadcastProposal
    ReproposeLocked --> BroadcastProposal
    ProposeNew --> BroadcastProposal
    BroadcastProposal --> NodesReceive
    NodesReceive --> ValidateProposal
    ValidateProposal --> CheckVoteLock
    CheckVoteLock -->|Locked| CanVote
    CheckVoteLock -->|Not Locked| Vote
    CanVote -->|Same block| Vote
    CanVote -->|Different block| BroadcastVote
    Vote --> BroadcastVote
    BroadcastVote --> CollectVotes
    CollectVotes --> QuorumCheck
    QuorumCheck -->|Yes| CreateQC
    QuorumCheck -->|No| Timeout
    CreateQC --> ViewSync
    ViewSync --> CommitCheck
    CommitCheck -->|Yes| Execute
    CommitCheck -->|No| Timeout
    Execute --> Recovered
    
    style Start fill:#ff6b6b
    style Timeout fill:#ff6b6b
    style FailureDetect fill:#ff6b6b
    style ClearVoteLock fill:#da77f2
    style KeepVoteLock fill:#da77f2
    style ViewIncrement fill:#ffd43b
    style LeaderElection fill:#4c6ef5
    style ReproposeLocked fill:#4c6ef5
    style ProposeNew fill:#4c6ef5
    style Vote fill:#51cf66
    style CreateQC fill:#51cf66
    style Execute fill:#ffd43b
    style Recovered fill:#51cf66
